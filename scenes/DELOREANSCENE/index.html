<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeLorean Scene - Versión 7</title>

    <style>
        body { margin: 0; overflow: hidden; background: black; }
        #loadingScreen {
            position: fixed; inset: 0;
            background: black; color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; z-index: 1000;
        }
        #startBtn {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            background: #00aaff;
            color: white; border: none; border-radius: 8px;
            font-size: 18px; cursor: pointer;
            z-index: 2000;
            display: none;
        }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="loadingScreen">Cargando...by victor albaro</div>
<button id="startBtn">INICIAR ENERGÍA</button>
<canvas id="webgl"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/draco_decoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/draco_wasm_wrapper.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/draco_wasm.js"></script>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>

<script>
/* ============================
   DETECCIÓN DE MÓVIL
============================ */
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ============================
   VARIABLES PRINCIPALES
============================ */
let scene, camera, renderer;
let delorean, ciudad;
let pivot;
let controls;
let listener, music;

let energyParticles, energyMaterial;
let rearOrbs = [];

let introOrbit = true;
let energyActivating = false;
let energyActive = false;
let finalOrbit = false;
let orbsFadingOut = false;

let energyTime = 0;

const ACTIVATION_DURATION = 20;
const DELOREAN_BASE_POS = new THREE.Vector3(0, 3, 0);
const FINAL_CAMERA_POS = new THREE.Vector3(0, 4, 14);

/* ============================
   INIT
============================ */
function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x080008);

    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000);
    camera.position.set(0, 1.8, 4.5);

    pivot = new THREE.Object3D();
    scene.add(pivot);
    pivot.add(camera);

    const canvas = document.getElementById("webgl");
    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(isMobile ? 1 : window.devicePixelRatio);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enabled = false;
    controls.minDistance = isMobile ? 2.1 : 3;
    controls.maxDistance = isMobile ? 18 : 40;
    controls.maxPolarAngle = Math.PI / 1.1;

    /* ============================
       LUCES
    ============================ */
    scene.add(new THREE.AmbientLight(0xffffff, 1));

    const dir = new THREE.DirectionalLight(0xff00ff, isMobile ? 0.25 : 0.5);
    dir.position.set(10, 20, 10);
    scene.add(dir);

    const point1 = new THREE.PointLight(0xffffff, isMobile ? 0.4 : 1, 200);
    point1.position.set(5, 10, 5);
    scene.add(point1);

    const rim = new THREE.DirectionalLight(0x0088ff, isMobile ? 0.1 : 0.8);
    rim.position.set(0, 5, -10); // detrás del coche
    scene.add(rim);

    const warmBounce = new THREE.PointLight(0xff6600, isMobile ? 0.1 : 0.2, 20);
    warmBounce.position.set(0, 1, 0); // justo debajo del coche
    scene.add(warmBounce);


    /* ============================
       ESTRELLAS (solo PC)
    ============================ */
    if (!isMobile) crearEstrellas();

    setupAudio();
    loadModels();

    window.addEventListener("resize", onResize);
    animate();
}

/* ============================
   ESTRELLAS
============================ */
function crearEstrellas() {
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 800;
    const positions = [];

    for (let i = 0; i < starCount; i++) {
        positions.push(
            (Math.random() - 0.5) * 2000,
            (Math.random() - 0.5) * 2000,
            (Math.random() - 0.5) * 2000
        );
    }

    starGeometry.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));

    const starMaterial = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.7
    });

    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);
}

/* ============================
   AUDIO
============================ */
function setupAudio() {
    listener = new THREE.AudioListener();
    camera.add(listener);

    music = new THREE.Audio(listener);

    const audioLoader = new THREE.AudioLoader();
    audioLoader.load("assets/musica.mp3", function(buffer) {
        music.setBuffer(buffer);
        music.setLoop(true);
        music.setVolume(0.4);
        music.play();
    });
}

/* ============================
   MODELOS
============================ */
function loadModels() {
    // Loader principal
    const loader = new THREE.GLTFLoader();
    const dracoLoader = new THREE.DRACOLoader();

// Ruta a los decoders (ya los cargaste arriba)
    dracoLoader.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/");
    loader.setDRACOLoader(dracoLoader);


    loader.load("assets/delorean_draco.glb/delorean.glb", function(gltf) {
    delorean = gltf.scene;
    delorean.position.copy(DELOREAN_BASE_POS);
    delorean.rotation.y = Math.PI;
    scene.add(delorean);

    crearEnergyParticles();
    crearRearOrbs();

    document.getElementById("loadingScreen").style.display = "none";
    document.getElementById("startBtn").style.display = "block";
});

loader.load("assets/ciudad_draco.glb/cityregresoFuturo.glb", function(gltf) {
    ciudad = gltf.scene;
    scene.add(ciudad);
});

}

/* ============================
   PARTÍCULAS
============================ */
function crearEnergyParticles() {
    const particleGeometry = new THREE.BufferGeometry();
    const count = isMobile ? 120 : 800;
    const positions = [];
    const radius = isMobile ? 2.2 : 4.3;

    for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const y = (Math.random() - 0.5) * 1.2;
        const r = radius * (0.5 + Math.random() * 0.5);

        positions.push(
            Math.cos(angle) * r,
            y,
            Math.sin(angle) * r
        );
    }

    particleGeometry.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));

    energyMaterial = new THREE.PointsMaterial({
        color: 0x66ccff,
        size: isMobile ? 0.02 : 0.03,
        transparent: true,
        opacity: 0.0
    });

    energyParticles = new THREE.Points(particleGeometry, energyMaterial);
    delorean.add(energyParticles);
}

/* ============================
   ORBS TRASEROS
============================ */
function crearRearOrbs() {
    const orbGeometry = new THREE.SphereGeometry(0.3, 16, 16);
    const orbMaterial = new THREE.MeshStandardMaterial({
        color: 0x00aaff,
        emissive: 0x0088ff,
        emissiveIntensity: 1.5,
        transparent: true,
        opacity: 1.0
    });

    const offsets = [
        new THREE.Vector3(-0.55, 1.2, -3.3),
        new THREE.Vector3( 0.55, 1.2, -3.3),
    ];

    offsets.forEach(offset => {
        const orb = new THREE.Mesh(orbGeometry, orbMaterial.clone());
        orb.position.copy(offset);
        orb.scale.set(0.1, 0.1, 0.1);
        delorean.add(orb);
        rearOrbs.push({ mesh: orb });
    });
}

/* ============================
   INICIAR ENERGÍA
============================ */
function iniciarEnergia() {
    if (!delorean || energyActivating || energyActive) return;

    document.getElementById("startBtn").style.display = "none";

    energyActivating = true;
    energyTime = 0;

    if (music && music.isPlaying) {
        music.setVolume(0.6);
    }
}

document.getElementById("startBtn").onclick = iniciarEnergia;

/* ============================
   ANIMATE
============================ */
function animate() {
    requestAnimationFrame(animate);

    const delta = 0.016;

    if (delorean) {
        pivot.position.copy(delorean.position);

        if (introOrbit) {
            pivot.rotation.y += isMobile ? 0.001 : 0.0015;
        }

        if (energyActivating) {
            energyTime += delta;

            const vib = isMobile ? 0.02 : 0.05;
            delorean.position.x = DELOREAN_BASE_POS.x + Math.sin(energyTime * 30) * vib;
            delorean.position.z = DELOREAN_BASE_POS.z + Math.cos(energyTime * 30) * vib;

            if (energyMaterial) {
                energyMaterial.opacity = Math.min(1.0, energyTime * 0.05);
            }

            rearOrbs.forEach((o, i) => {
                const baseScale = 0.1 + Math.min(energyTime * 0.1, 1.0);
                const pulse = 1.0 + Math.sin(energyTime * 10 + i) * 0.2;
                const s = baseScale * pulse;
                o.mesh.scale.set(s, s, s);
            });

            pivot.rotation.y += isMobile ? 0.002 : 0.003;

            if (energyTime > ACTIVATION_DURATION) {
                energyActivating = false;
                introOrbit = false;

                delorean.position.copy(DELOREAN_BASE_POS);

                if (energyMaterial) {
                    energyMaterial.opacity = 0.8;
                }

                orbsFadingOut = true;

                if (isMobile) {
                    controls.enabled = true;
                    controls.target.copy(delorean.position);
                    controls.update();
                    energyActive = true;
                } else {
                    finalOrbit = true;
                }

                if (music && music.isPlaying) {
                    music.setVolume(0.45);
                }
            }
        }

        if (finalOrbit && !isMobile) {
            pivot.rotation.y += 0.0015;

            camera.position.lerp(FINAL_CAMERA_POS, 0.01);

            if (camera.position.distanceTo(FINAL_CAMERA_POS) < 0.2) {
                finalOrbit = false;
                energyActive = true;

                controls.enabled = true;
                controls.target.copy(delorean.position);
                controls.update();
            }
        }

        if (orbsFadingOut) {
            rearOrbs.forEach(o => {
                o.mesh.material.opacity -= 0.01;
                o.mesh.scale.multiplyScalar(0.97);

                if (o.mesh.material.opacity <= 0) {
                    delorean.remove(o.mesh);
                }
            });

            if (rearOrbs.every(o => o.mesh.material.opacity <= 0)) {
                orbsFadingOut = false;
            }
        }

        if (energyActive) {
            const t = performance.now() * 0.001;
            const vib = isMobile ? 0.015 : 0.03;

            delorean.position.x = DELOREAN_BASE_POS.x + Math.sin(t * 15) * vib;
            delorean.position.z = DELOREAN_BASE_POS.z + Math.cos(t * 15) * vib;

            if (energyParticles) {
                energyParticles.rotation.y += 0.004;
            }
        }
    }

    renderer.render(scene, camera);
}

/* ============================
   RESIZE
============================ */
function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

window.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
